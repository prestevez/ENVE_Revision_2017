---
title: "Repeat extortion of Mexican businesses: Revision analysis"
author: "Patricio R. Estevez Soto"
email: "patricio.estevez.14@ucl.ac.uk"
date: "4/05/2016"
output:
  md_document:
    variant: "markdown"
pandoc_args: "--smart"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment="",
                      cache=TRUE,
                      dev=c("png", "CairoPDF"),
                      error=TRUE)
```

# Introduction

Script to analyze patterns of extortion victimization against Mexican businesses.

# Set up, data input and pre-process

## Session info

We first check details of the session and system, and for reproducibility, we set the random seed.

```{r session, cache=FALSE}
starttime <- proc.time()
date()
sessionInfo()
set.seed(42)
options(scipen=0)
```

## Load packages and functions

Install custom package, requires `devtools`.

```{r install-estevez}
devtools::install_github("prestevez/estevez")
```

Next we load the packages that we will use.

```{r packages}
library(estevez)
library(foreign)
library(ggplot2)
library(Cairo)
library(knitr)
#library(texreg)
library(lme4)
library(glmmADMB)
library(classInt)
library(dplyr)
library(reshape2)
```



## Data input

Load the data for the study.

```{r import-data}
enve_all <- read.dbf("enve2014cuest_ciega_2014.dbf")
cat_entidades <- read.csv("cat_entidades.csv", head=TRUE)
area_level_tmp <- read.csv("state_level_data.csv", header=TRUE)
area_level <- merge(area_level_tmp, cat_entidades, by="CVE_ENT", all.x=TRUE)
scode <- read.csv("secode.csv", head=TRUE)
scode$Code <- scode$Code*10000
```


Quick overview of all the variables in the dataset

```{r overview-all}

summary(enve_all)

```

Now select only the relevant variables

```{r extortion-variables-selection}

enve_test <- data.frame(extortions=as.integer(as.character(enve_all$P26_10)))

enve_test$extortion_victim <- enve_all$P25_10
enve_test$extortions[enve_test$extortion_victim == 2] <- 0

summary(enve_test$extortions)
table(enve_test$extortions)

enve_test$extortions_nas <- enve_test$extortions
enve_test$extortions[is.na(enve_test$extortions)] <- 0

summary(enve_test$extortions)
table(enve_test$extortions)

levels(enve_test$extortion_victim) <- c("yes", "no", "dk")
enve_test$extortion_victim <- relevel(enve_test$extortion_victim, ref = "no")

enve_test$rep_extortion_victim <- factor(enve_test$extortions)
levels(enve_test$rep_extortion_victim) <- c(0, 0,
                    rep(1, length(levels(enve_test$rep_extortion_victim)) - 2))

summary(enve_test$rep_extortion_victim)


summary(enve_test)
```



```{r bribes-variables-selection}

enve_test$bribes <- as.integer(as.character(enve_all$P33))
summary(enve_test$bribes)


# 4 bribe cats
enve_test$bribe1 <- enve_all$P29_1
enve_test$bribe2 <- enve_all$P30_1
enve_test$bribe3 <- enve_all$P31_1
enve_test$bribe4 <- enve_all$P32_1

enve_test$bribes[with(enve_test,
                        bribe1 == 2 &
                        bribe2 == 2 &
                        bribe3 == 2 &
                        bribe4 == 2)] <- 0

summary(enve_test$bribes)

enve_test$bribe_victim[enve_test$bribes > 0] <- 1
enve_test$bribe_victim[with(enve_test,
                        bribe1 == 2 &
                        bribe2 == 2 &
                        bribe3 == 2 &
                        bribe4 == 2)] <- 0

enve_test$bribe_victim[with(enve_test,
                        bribe1 == 9 &
                        bribe2 == 9 &
                        bribe3 == 9 &
                        bribe4 == 9)] <- 9

enve_test %>%
    mutate(bribe_victim = as.factor(bribe_victim)) -> enve_test

levels(enve_test$bribe_victim) <- c("no", "yes", "dk")

bribecols <- c("bribe1",
               "bribe2",
               "bribe3",
               "bribe4")

colindbribe <- which(names(enve_test) %in% bribecols)

enve_test <- enve_test[,-colindbribe]

enve_test$bribes_nas <- enve_test$bribes

enve_test$bribes[is.na(enve_test$bribes)] <- 0


summary(enve_test)
```

```{r other-variables-selection}
enve_test$CVE_UNICA <- as.integer(as.character(enve_all$ID_CONSECU))

enve_test$CVE_ENT <- as.integer(as.character(enve_all$CVE_ENT))

enve_test$size <- enve_all$ID_ESTRATO
levels(enve_test$size) <- c("Large", "Medium", "Small", "Micro")

enve_test$sector <- enve_all$SECTOR_FIN

# subsector
enve_test$tempsub <- as.integer(as.character(enve_all$P1_1B))
enve_test$subsector <- cut(enve_test$tempsub, scode$Code, right=FALSE)
levels(enve_test$subsector) <- scode$Sector
enve_test$subsector <- droplevels(enve_test$subsector)
enve_test$subsector <- relevel(enve_test$subsector, ref="Retail")
levels(enve_test$subsector)

### To exclude the subsectors with very few observations

# summary(enve_test)
# nrow(enve_test)
# enve_test %>%
#     filter(subsector != "Utilities") %>%
#     filter(subsector != "Corporate") -> enve_test_2
# 
# enve_test_2$subsector <- droplevels(enve_test_2$subsector)
# 
# levels(enve_test_2$subsector)
# nrow(enve_test_2)

enve_test$years <- 2013 - as.numeric(as.character(enve_all$P3))
intyears <- classIntervals(enve_test$years, 5, style="quantile")
enve_test$yearsquant <- cut(enve_test$years, intyears$brks, right=TRUE,
                            include.lowest = TRUE)

intyears_deciles <- classIntervals(enve_test$years, 10, style="quantile")
enve_test$years_deciles <- cut(enve_test$years, intyears_deciles$brks, right=TRUE,
                            include.lowest = TRUE)


enve_test <- merge(enve_test, area_level, by="CVE_ENT", all.x=TRUE)

length(enve_test$extortions[is.na(enve_test$extortions)])
length(enve_test$bribes[is.na(enve_test$bribes)])

## Summary of final dataset
summary(enve_test)

```
## Incident module

Add data from the incident module to briefly, **briefly**, analyse the distributions of extortion according to modus operandi.

``` {r incident-module}
enve_incidents_all <- read.dbf("enve2014delitos_ciega_2014.dbf")

# Selecting only those relevant for extortion (code 10)
enve_incidents_all$delito <- as.integer(as.character(enve_incidents_all$ID_DELITO))
enve_incidents <- enve_incidents_all[enve_incidents_all$delito == 10,]

incident_df <- data.frame(CVE_UNICA=as.integer(as.character(enve_incidents$ID_CONSECU)))

incident_df$delito <- enve_incidents$delito

incident_df$type <- as.character(enve_incidents$M5_1)
incident_df$type <- as.factor(incident_df$type)
levels(incident_df$type) <- c("Telephone", "Internet", "Street",
                                        "Premises", "Cobro de piso", "Other")

incident_df$simp <- incident_df$type
levels(incident_df$simp) <- c("Remote", "Remote", "In person",
                                        "In person", "In person", "Other")

# Transform the factors into dummy variables

type_dummy <- data.frame(model.matrix( ~ type -1 , data = incident_df))

simple_dummy <- data.frame(model.matrix( ~ simp -1 , data = incident_df))

incident_df <- cbind(incident_df, type_dummy, simple_dummy)


summary(incident_df)
```

Next we merge both incident-level and victim-level tables, and produce a new business-level table with counts based on the incident module.

```{r incident-victim-merge}

enve_incvic <- merge(incident_df, enve_test, by="CVE_UNICA")

summary(enve_incvic)
nrow(enve_incvic)
nrow(enve_test)

head(melt(enve_incvic))

enve_incvic %>%
    group_by(CVE_UNICA) %>%
    summarise(n()) %>%
    head
```

# EDA

## Extortion vs Years

First a brief EDA analysis of the years variable, using a facet plot of the bivariate relationship with extortion incidents.

```{r years-plots}

enve_test %>%
    select(extortions, years, yearsquant, years_deciles) -> gg_ext_years



years_scatterplots <- ggplot(gg_ext_years, aes(x = years, y = extortions))

years_scatterplots + geom_point() + theme_bw() + geom_smooth(method = "lm")

# Quintiles

years_scatterplots + 
    geom_point() + 
    theme_bw() + 
    facet_wrap(~ yearsquant, scales = "free_x") + 
    geom_smooth(method = "lm")

# For deciles

years_scatterplots + 
    geom_point() + 
    theme_bw() + 
    facet_wrap(~ years_deciles, scales = "free_x") + 
    geom_smooth(method = "lm")

```

## Extortion prevalence contingency tables

This function tests the association between extortion and a vector of variables (still need to programatically create the tables TO DO)

```{r freq-table-test}

ext_preval_tbl_test <- many.ftables.tst(enve_test, DV = "extortion_victim",
                                        IV = c("bribe_victim",
                                               "size",
                                               "subsector",
                                               "yearsquant",
                                               "years_deciles",
                                               "NOM_ENT"),
                                        print.special = "pandoc")

ext_preval_tbl_test

repext_preval_tbl_test <- many.ftables.tst(enve_test, DV = "rep_extortion_victim",
                                        IV = c("bribe_victim",
                                               "size",
                                               "subsector",
                                               "yearsquant",
                                               "years_deciles",
                                               "NOM_ENT"),
                                        print.special = "pandoc")

repext_preval_tbl_test


```

To do tomorrow:
- For the EDA, create a facet ggplot for the years variable (done)
- create new variable for repeat extortion victim (done)
- Do contingency tables for the extortion (and repeat extortion) victim variable (use a function) (did the tests, now need to print the tables)

- calculate the true prevalence and incidence to make sure it matches the one I calculated for the state values
- If I do exclude the NAs, redo the EDA analysis
- Add chunk to load functions as needed.
- Then let's start adding the models, as including new state-level variables, would probably have to rerun all of them
- Also, will need to run ZIP and hurdle. should optimise the modelling strategy, as we know it can be extremely time consuming. (should probably exclude cols with NAs to avoid errors), will attempt all with glmmadmb.


