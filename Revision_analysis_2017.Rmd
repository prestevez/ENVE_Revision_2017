---
title: "Repeat extortion of Mexican businesses: Revision analysis"
author: "Patricio R. Estevez Soto"
email: "patricio.estevez.14@ucl.ac.uk"
date: "01/06/2017"
output:
  md_document:
    variant: "markdown"
pandoc_args: "--smart"
---

# Introduction

Script to analyze patterns of extortion victimization against Mexican businesses.

# Set up, data input and pre-process

## Session info

We first check details of the session and system, and for reproducibility, we set the random seed.

```{r session, cache=FALSE}
starttime <- proc.time()
date()
sessionInfo()
set.seed(42)
options(scipen=0)
```

## Load packages and functions

Install custom package, requires `devtools`.

```{r install-victim}
# devtools::install_github("prestevez/victim")
```

Next we load the packages that we will use.

```{r packages}
library(victim)
library(foreign)
library(ggplot2)
library(Cairo)
library(knitr)
library(texreg)
library(lme4)
library(glmmADMB)
library(classInt)
library(dplyr)
library(reshape2)
library(lmtest)
library(car)
library(pscl)
sessionInfo()
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment="",
                      cache=TRUE,
                      dev=c("png", "CairoPDF"),
                      error=TRUE,
                      fig.width=4, fig.height=3)
options(knitr.kable.NA = '--')
```


## Data input

Load the data for the study.

```{r import-data}
enve_all <- read.dbf("enve2014cuest_ciega_2014.dbf")
cat_entidades <- read.csv("cat_entidades.csv", head=TRUE)
area_level_tmp <- read.csv("state_level_data.csv", header=TRUE)
area_level <- merge(area_level_tmp, cat_entidades, by="CVE_ENT", all.x=TRUE)
scode <- read.csv("secode.csv", head=TRUE)
scode$Code <- scode$Code*10000
```


Quick overview of all the variables in the dataset

```{r overview-all}

summary(enve_all)

```

Now select only the relevant variables

```{r extortion-variables-selection}

enve_test <- data.frame(extortions=as.integer(as.character(enve_all$P26_10)))

enve_test$extortion_victim <- enve_all$P25_10
enve_test$extortions[enve_test$extortion_victim == 2] <- 0

summary(enve_test$extortions)
table(enve_test$extortions)

enve_test$extortions_nas <- enve_test$extortions
enve_test$extortions[is.na(enve_test$extortions)] <- 0

summary(enve_test$extortions)
table(enve_test$extortions)

levels(enve_test$extortion_victim) <- c("yes", "no", "dk")
enve_test$extortion_victim <- relevel(enve_test$extortion_victim, ref = "no")

enve_test$rep_extortion_victim <- factor(enve_test$extortions)
levels(enve_test$rep_extortion_victim) <- c(0, 0,
                    rep(1, length(levels(enve_test$rep_extortion_victim)) - 2))

summary(enve_test$rep_extortion_victim)


summary(enve_test)
```



```{r bribes-variables-selection}

enve_test$bribes <- as.integer(as.character(enve_all$P33))
summary(enve_test$bribes)


# 4 bribe cats
enve_test$bribe1 <- enve_all$P29_1
enve_test$bribe2 <- enve_all$P30_1
enve_test$bribe3 <- enve_all$P31_1
enve_test$bribe4 <- enve_all$P32_1

enve_test$bribes[with(enve_test,
                        bribe1 == 2 &
                        bribe2 == 2 &
                        bribe3 == 2 &
                        bribe4 == 2)] <- 0

summary(enve_test$bribes)

enve_test$bribe_victim[enve_test$bribes > 0] <- 1
enve_test$bribe_victim[with(enve_test,
                        bribe1 == 2 &
                        bribe2 == 2 &
                        bribe3 == 2 &
                        bribe4 == 2)] <- 0

enve_test$bribe_victim[with(enve_test,
                        bribe1 == 9 &
                        bribe2 == 9 &
                        bribe3 == 9 &
                        bribe4 == 9)] <- 9

enve_test %>%
    mutate(bribe_victim = as.factor(bribe_victim)) -> enve_test

levels(enve_test$bribe_victim) <- c("no", "yes", "dk")

bribecols <- c("bribe1",
               "bribe2",
               "bribe3",
               "bribe4")

colindbribe <- which(names(enve_test) %in% bribecols)

enve_test <- enve_test[,-colindbribe]

enve_test$bribes_nas <- enve_test$bribes

enve_test$bribes[is.na(enve_test$bribes)] <- 0


summary(enve_test)
```

```{r other-variables-selection}
enve_test$CVE_UNICA <- as.integer(as.character(enve_all$ID_CONSECU))

enve_test$CVE_ENT <- as.integer(as.character(enve_all$CVE_ENT))

enve_test$size <- enve_all$ID_ESTRATO
levels(enve_test$size) <- c("Large", "Medium", "Small", "Micro")

enve_test$sector <- enve_all$SECTOR_FIN

# subsector
enve_test$tempsub <- as.integer(as.character(enve_all$P1_1B))
enve_test$subsector <- cut(enve_test$tempsub, scode$Code, right=FALSE)
levels(enve_test$subsector) <- scode$Sector
enve_test$subsector <- droplevels(enve_test$subsector)
enve_test$subsector <- relevel(enve_test$subsector, ref="Retail")
levels(enve_test$subsector)

enve_test$years <- 2013 - as.numeric(as.character(enve_all$P3))
intyears <- classIntervals(enve_test$years, 5, style="quantile")
enve_test$yearsquant <- cut(enve_test$years, intyears$brks, right=TRUE,
                            include.lowest = TRUE)

intyears_deciles <- classIntervals(enve_test$years, 10, style="quantile")
enve_test$years_deciles <- cut(enve_test$years, intyears_deciles$brks, right=TRUE,
                            include.lowest = TRUE)


enve_test <- merge(enve_test, area_level, by="CVE_ENT", all.x=TRUE)

length(enve_test$extortions[is.na(enve_test$extortions)])
length(enve_test$bribes[is.na(enve_test$bribes)])

### To exclude the subsectors with very few observations

summary(enve_test)
nrow(enve_test)
enve_test %>%
    filter(subsector != "Utilities") %>%
    filter(subsector != "Corporate") -> enve_test_2

enve_test_2$subsector <- droplevels(enve_test_2$subsector)

levels(enve_test_2$subsector)
nrow(enve_test_2)

enve_test <- enve_test_2

####

## Summary of final dataset
summary(enve_test)

```
## Incident module

Add data from the incident module to briefly, **briefly**, analyse the distributions of extortion according to modus operandi.

``` {r incident-module}
enve_incidents_all <- read.dbf("enve2014delitos_ciega_2014.dbf")

# Selecting only those relevant for extortion (code 10)
enve_incidents_all$delito <- as.integer(as.character(enve_incidents_all$ID_DELITO))
enve_incidents <- enve_incidents_all[enve_incidents_all$delito == 10,]

incident_df <- data.frame(CVE_UNICA=as.integer(as.character(enve_incidents$ID_CONSECU)))

incident_df$delito <- enve_incidents$delito

incident_df$type <- as.character(enve_incidents$M5_1)
incident_df$type <- as.factor(incident_df$type)
levels(incident_df$type) <- c("Telephone", "Internet", "Street",
                                        "Premises", "Cobro de piso", "Other")

incident_df$simp <- incident_df$type
levels(incident_df$simp) <- c("Remote", "Remote", "In person",
                                        "In person", "In person", "Other")

# Transform the factors into dummy variables

type_dummy <- data.frame(model.matrix( ~ type -1 , data = incident_df))

simple_dummy <- data.frame(model.matrix( ~ simp -1 , data = incident_df))

incident_df <- cbind(incident_df, type_dummy, simple_dummy)

summary(incident_df)
```

Next we merge both incident-level and victim-level tables, and produce a new business-level table with counts based on the incident module.

```{r incident-victim-merge}

enve_incvic <- merge(incident_df, enve_test, by="CVE_UNICA", all.y = TRUE)

summary(enve_incvic)
nrow(enve_incvic)
nrow(enve_test)
length(unique(enve_incvic$CVE_UNICA))

enve_incvic %>%
    group_by(CVE_UNICA) %>%
    summarise(typeTelephone = sum(typeTelephone),
              typeInternet = sum(typeInternet),
              typeStreet = sum(typeStreet),
              typePremises = sum(typePremises),
              typeCobro.de.piso = sum(typeCobro.de.piso),
              typeOther = sum(typeOther),
              simpRemote = sum(simpRemote),
              simpIn.person = sum(simpIn.person),
              simpOther = sum(simpOther)) -> enve_type_counts

enve_type_counts[(is.na(enve_type_counts))] <- 0

nrow(enve_type_counts)

enve_type_counts %>%
    mutate(cap_count = simpRemote + simpIn.person + simpOther,
           propTel = typeTelephone/cap_count,
           propInternet = typeInternet/cap_count,
           propStreet = typeStreet/cap_count,
           propPremises = typePremises/cap_count,
           propPiso = typeCobro.de.piso/cap_count,
           propOther = typeOther/cap_count,
           propRemote = simpRemote/cap_count,
           propIn.person = simpIn.person/cap_count) -> enve_type_counts_and_props

enve_type_counts_and_props[is.na(enve_type_counts_and_props)] <- 0

enve_test %>%
    left_join(enve_type_counts_and_props, by = "CVE_UNICA") %>%
    mutate(estTel = round(propTel * extortions),
           estInternet = round(propInternet * extortions),
           estStreet =  round(propStreet * extortions),
           estPremises = round(propPremises * extortions),
           estPiso = round(propPiso * extortions),
           estOther = round(propOther * extortions),
           estRemote = round(propRemote * extortions),
           estIn.person = round(propIn.person * extortions)) -> enve_final

summary(enve_final)

```

# EDA

Re-do some of the EDA

## Univariate extortion analysis

Distribution, lorenz plots and poisson tests for the aggregated extortion counts in the screening questionnaire

```{r univariate-EDA}

extortion_columns1 <- c("extortions", "extortions_nas")

extortion_dist1 <- lapply(extortion_columns1, victim_table,
                          data = enve_final, print_option = "pandoc")

names(extortion_dist1) <- extortion_columns1

extortion_dist1

extortion_dist1 <- lapply(extortion_columns1, victim_table,
                          data = enve_final, print_option = "none")

names(extortion_dist1) <- extortion_columns1

ext1_vicum <- lapply(extortion_dist1, victim_cumulative)

lapply(ext1_vicum, kable, format = "pandoc", digits = 3)

```

```{r extortions1-lorenz}

lapply(extortion_columns1, victim_lorenz,
       data = enve_final, family = "none")

victim_lorenz("extortions", enve_final, family = "poisson")

victim_lorenz("extortions", enve_final, family = "nbinom")

```

Now do some MC gini tests, Index of dispersion tests, and KS tests

```{r extortions1-tests}

mc_gini_test("extortions", enve_final, family = "poisson", plots = TRUE)
mc_gini_test("extortions", enve_final, family = "nbinom", plots = TRUE)

dispersion_batch("extortions", enve_final, print_option = "pandoc")

my_ks_test("extortions", enve_final)

my_ks_test("extortions", enve_final, family = "nbinom")

ext_chisq_poiss <- chisq_count("extortions", data = enve_final, B = 2000,
                               family = "poisson")

ext_chisq_poiss

ext_chisq_poiss_tb <- data.frame(ext_chisq_poiss$observed,
                                 Exp = ext_chisq_poiss$expected)[,c(1,2,4)]

kable(ext_chisq_poiss_tb, format = "pandoc", digits = 3,
      caption = "Poisson expected counts")

ext_chisq_nbinom <- chisq_count("extortions", data = enve_final, B = 2000,
                               family = "nbinom")

ext_chisq_nbinom

ext_chisq_nbinom_tb <- data.frame(ext_chisq_nbinom$observed,
                                 Exp = ext_chisq_nbinom$expected)[,c(1,2,4)]

kable(ext_chisq_nbinom_tb, format = "pandoc", digits = 3,
      caption = "Negative binomial expected counts")

## Neg Bin distribution parameters for extortion

MASS::fitdistr(enve_final$extortions, "Negative Binomial")

```

## Univariate: other extortion types

Now do the univariate analysis for the rest of the extortion variables. First for the capped counts.

```{r extortions-capped-univariate-distribution}

extortion_columns_capped <- c("typeTelephone",
                              "typeInternet",
                              "typeStreet",
                              "typePremises",
                              "typeCobro.de.piso",
                              "typeOther",
                              "simpRemote",
                              "simpIn.person",
                              "cap_count")

extortion_dist_capped <- lapply(extortion_columns_capped, victim_table,
                          data = enve_final, print_option = "pandoc")

names(extortion_dist_capped) <- extortion_columns_capped
extortion_dist_capped


extortion_dist_capped_nformat <- lapply(extortion_columns_capped, victim_table,
                          data = enve_final, print_option = "none")

names(extortion_dist_capped_nformat) <- extortion_columns_capped

ext_capped_vicum <- lapply(extortion_dist_capped_nformat, victim_cumulative)

lapply(ext_capped_vicum, kable, format = "pandoc", digits = 3)


```

```{r extortion-capped-lorenz}

lapply(extortion_columns_capped, victim_lorenz, data = enve_final,
       family = "poisson")

lapply(extortion_columns_capped, victim_lorenz, data = enve_final,
       family = "nbinom")

```

Now do some hypothesis testing

```{r capped-extortions-tests}

lapply(extortion_columns_capped, mc_gini_test, data = enve_final,
       family = "poisson", plots = TRUE)

lapply(extortion_columns_capped, mc_gini_test, data = enve_final,
       family = "nbinom", plots = TRUE)

dispersion_batch(extortion_columns_capped, enve_final, print_option = "pandoc")

ks_test_batch(extortion_columns_capped, enve_final, print_option = "pandoc",
              family = "poisson")

ks_test_batch(extortion_columns_capped, enve_final, print_option = "pandoc",
              family = "nbinom")

# poisson expected chisq

ext_cap_chisq_p <- lapply(extortion_columns_capped, function(x)
{
    tryCatch(chisq_count(x, data = enve_final, B = 2000),
             error = function(e) NULL)
})

ext_cap_chisq_p

kable(chisq_tb(ext_cap_chisq_p), format = "pandoc", digits = 3)


ext_cap_p_tb <- lapply(ext_cap_chisq_p, function(x)
    {
    kable(data.frame(x$observed, Exp = x$expected)[,c(1,2,4)],
          format = "pandoc", digits = 3, caption = "Expected: Poisson")
    })


print_kables(ext_cap_p_tb)

# now for negbin

ext_cap_chisq_nb <- lapply(extortion_columns_capped, function(x)
{
    tryCatch(chisq_count(x, data = enve_final, B = 2000, family = "nbinom"),
             error = function(e) NULL)
})

ext_cap_chisq_nb

kable(chisq_tb(ext_cap_chisq_nb), format = "pandoc", digits = 3)


ext_cap_nb_tb <- lapply(ext_cap_chisq_nb, function(x)
    {
    kable(data.frame(x$observed, Exp = x$expected)[,c(1,2,4)],
          format = "pandoc", digits = 3, caption = "Expected: negbin")
    })


print_kables(ext_cap_nb_tb)

```



Now do the estimated counts

```{r estimated-extortion-univariate distributions}

extortion_columns_estimated <- c("estTel",
                              "estInternet",
                              "estStreet",
                              "estPremises",
                              "estPiso",
                              "estOther",
                              "estRemote",
                              "estIn.person")

extortion_dist_estimated <- lapply(extortion_columns_estimated, function(x)
                                {
                                    if(mean(enve_final[,x]) == 0){message(paste0("skipping ", x, ". No obs."))}
                                    else{victim_table(x, data = enve_final, print_option = "pandoc")}
                                })

names(extortion_dist_estimated) <- extortion_columns_estimated

extortion_dist_estimated


extortion_dist_estimated_nfor <- lapply(extortion_columns_estimated, function(x)
                                {
                                    if(mean(enve_final[,x]) == 0){message(paste0("skipping ", x, ". No obs."))}
                                    else{victim_table(x, data = enve_final, print_option = "none")}
                                })

names(extortion_dist_estimated_nfor) <- extortion_columns_estimated

ext_estim_vicum <- lapply(extortion_dist_estimated_nfor,
                          function(x) {if(is.null(x)){message("skipping NULL objects")}
                              else {victim_cumulative(x)}}
                          )

print_kables(lapply(ext_estim_vicum,
       function(x) {if(is.null(x)){message("skipping NULL objects")}
                    else {kable(x, format = "pandoc", digits = 3)}}))

```

```{r extortion-estimated-lorenz}

lapply(extortion_columns_estimated, function(x)
{
    tryCatch(victim_lorenz(x, data = enve_final, family = "poisson"),
             error = function(e) NULL)
})

lapply(extortion_columns_estimated, function(x)
{
    tryCatch(victim_lorenz(x, data = enve_final, family = "nbinom"),
             error = function(e) NULL)
})

```


```{r estimated-extortions-tests}

lapply(extortion_columns_estimated, function(x)
{
    tryCatch(mc_gini_test(x, data = enve_final, family = "poisson",
                          plots = TRUE), error = function(e) NULL)
})

lapply(extortion_columns_estimated, function(x)
{
    tryCatch(mc_gini_test(x, data = enve_final, family = "nbinom",
                          plots = TRUE), error = function(e) NULL)
})

dispersion_batch(extortion_columns_estimated, enve_final, print_option = "pandoc")

ks_test_batch(extortion_columns_estimated, enve_final, print_option = "pandoc",
              family = "poisson")

ks_test_batch(extortion_columns_estimated, enve_final, print_option = "pandoc",
              family = "nbinom")

# poisson expected chisq

ext_est_chisq_p <- lapply(extortion_columns_estimated, function(x)
{
    tryCatch(chisq_count(x, data = enve_final, B = 2000),
             error = function(e) NULL)
})

ext_est_chisq_p

kable(chisq_tb(ext_est_chisq_p), format = "pandoc", digits = 3)


ext_est_p_tb <- lapply(ext_est_chisq_p, function(x)
    {
    if(is.null(x)) {"skipping null objects"}
    else
    {
        kable(data.frame(x$observed, Exp = x$expected)[,c(1,2,4)],
          format = "pandoc", digits = 3, caption = "Expected: Poisson")
    }
    })


print_kables(ext_est_p_tb)

# nbinom expected chisq

ext_est_chisq_nb <- lapply(extortion_columns_estimated, function(x)
{
    tryCatch(chisq_count(x, data = enve_final, B = 2000,
                         family = "nbinom"),
             error = function(e) NULL)
})

ext_est_chisq_nb

kable(chisq_tb(ext_est_chisq_nb), format = "pandoc", digits = 3)


ext_est_nb_tb <- lapply(ext_est_chisq_nb, function(x)
    {
    if(is.null(x)) {"skipping null objects"}
    else
    {
      kable(data.frame(x$observed, Exp = x$expected)[,c(1,2,4)],
          format = "pandoc", digits = 3, caption = "Expected: nbinom")  
    }
    })


print_kables(ext_est_nb_tb)

```

## IQV

Calculate the index of qualitative variation per business, then analyse these figures.

```{r iqv}

cols <- c("typeTelephone", "typeInternet", "typeStreet",
          "typePremises", "typeCobro.de.piso", "typeOther")

iqv_long <- iqv(enve_final[,cols])

iqv_long

enve_final$iqv_long <- apply(enve_final[,cols], 1, iqv)

enve_final$iqv_long <- round(enve_final$iqv_long, 2)

summary(enve_final$iqv_long)

# now for simp cats

cols_simp <- c("simpRemote", "simpIn.person", "simpOther")

iqv_simp <- iqv(enve_final[,cols_simp])

iqv_simp

enve_final$iqv_simp <- apply(enve_final[,cols_simp], 1, iqv)

enve_final$iqv_simp <- round(enve_final$iqv_simp, 2)

summary(enve_final$iqv_simp)

## Contingency tables to extortion frequency

batch_iqvs <- batch_chisq(enve_final, "extortions",
                          c("iqv_long", "iqv_simp"))

kable(chisq_tb(batch_iqvs, stars = TRUE), "pandoc",
      caption = "Chi-squared tests between 'extortions' and 'IQVs'" )

print_kables(chisq_list(batch_iqvs, option = "observed", print_option = "pandoc"))

print_kables(chisq_list(batch_iqvs, option = "ratio", print_option = "pandoc"))

print_kables(chisq_list(batch_iqvs, option = "percent", print_option = "pandoc"))


```

# Bivariate EDA

## Extortion prevalence

```{r ext-prevalence-vs-bribes}

ivs <- c("bribes",
         "bribe_victim",
         "size",
         "subsector",
         "yearsquant",
         "years_deciles")

ext_p_batch_chsq <- batch_chisq(df = enve_final, DV = "extortion_victim", IV = ivs)

kable(chisq_tb(ext_p_batch_chsq, stars = TRUE), "pandoc",
      caption = "Chi-square tests between 'extortion prevalence' and a set of DV")

print_kables(chisq_list(ext_p_batch_chsq, option = "observed", print_option = "pandoc"))

print_kables(chisq_list(ext_p_batch_chsq, option = "ratio", print_option = "pandoc"))

print_kables(chisq_list(ext_p_batch_chsq, option = "percent", print_option = "pandoc"))


```

## Extortion distribution

```{r ext-distribution-vs-bribes}

ivs <- c("bribes",
         "bribe_victim",
         "size",
         "subsector",
         "yearsquant",
         "years_deciles")

ext_p_batch_chsq <- batch_chisq(df = enve_final, DV = "extortions", IV = ivs)

kable(chisq_tb(ext_p_batch_chsq, stars = TRUE), "pandoc",
      caption = "Chi-square tests between 'extortion counts' and a set of DV")

print_kables(chisq_list(ext_p_batch_chsq, option = "observed", print_option = "pandoc"))

print_kables(chisq_list(ext_p_batch_chsq, option = "ratio", print_option = "pandoc"))

print_kables(chisq_list(ext_p_batch_chsq, option = "percent", print_option = "pandoc"))


```

## Extortion vs Years

A brief EDA analysis of the years variable, using a facet plot of the bivariate relationship with extortion incidents.

```{r years-plots}

enve_final %>%
    dplyr::select(extortions, years, yearsquant) %>%
    mutate("All years" = "All years")-> gg_ext_years1

melt(gg_ext_years1,
     id.vars = c("extortions", "years"),
     value.name = "yearsquant") -> gg_ext_years1

enve_final %>%
    dplyr::select(extortions, years, years_deciles) %>%
    mutate("All years" = "All years")-> gg_ext_years2

melt(gg_ext_years2,
     id.vars = c("extortions", "years"),
     value.name = "years_deciles") -> gg_ext_years2

cbind(gg_ext_years1, years_deciles = gg_ext_years2$years_deciles) -> gg_ext_years

gg_ext_years$yearsquant <- factor(gg_ext_years$yearsquant)

gg_ext_years$yearsquant <- relevel(gg_ext_years$yearsquant, ref = "All years")

gg_ext_years$yearsquant <- factor(gg_ext_years$yearsquant,
                                  levels = c("All years", levels(enve_final$yearsquant)))

gg_ext_years$years_deciles <- relevel(gg_ext_years$years_deciles, ref = "All years")

gg_ext_years$years_deciles <- factor(gg_ext_years$years_deciles,
                                  levels = c("All years", levels(enve_final$years_deciles)))

gg_ext_years <- dplyr::select(gg_ext_years, -variable)

years_scatterplots <- ggplot(gg_ext_years, aes(x = years, y = extortions))

years_scatterplots + geom_point() + theme_bw() + geom_smooth(method = "lm")
```

``````{r years-plots-quintiles, fig.width = 6, fig.height = 5}

# Quintiles

years_scatterplots +
    geom_point() +
    theme_bw() +
    facet_wrap(~ yearsquant, scales = "free_x") +
    geom_smooth(method = "lm")

# For deciles

years_scatterplots +
    geom_point() +
    theme_bw() +
    facet_wrap(~ years_deciles, scales = "free_x") +
    geom_smooth(method = "lm")

# Excluding the all business line

years_scatterplots <- ggplot(subset(gg_ext_years, yearsquant != "All years"),
                             aes(x = years, y = extortions))

years_scatterplots +
    geom_point() +
    theme_bw() +
    geom_smooth(method = "lm", aes(colour = yearsquant))

## Only for victims

years_scatterplots <- ggplot(subset(gg_ext_years, yearsquant != "All years" &
                                        extortions > 0),
                             aes(x = years, y = extortions))

years_scatterplots +
    geom_point() +
    theme_bw() +
    geom_smooth(method = "lm", aes(colour = yearsquant), se = FALSE)

years_scatterplots +
    geom_point() +
    theme_bw() +
    geom_smooth(method = "lm", aes(colour = yearsquant), se = FALSE) +
    scale_x_sqrt()


# Only for victims with a grid

years_scatterplots <- ggplot(subset(gg_ext_years, extortions > 0),
                             aes(x = years, y = extortions))


# Quintiles

years_scatterplots +
    geom_point() +
    theme_bw() +
    facet_wrap(~ yearsquant, scales = "free_x") +
    geom_smooth(method = "lm")

# For deciles

years_scatterplots +
    geom_point() +
    theme_bw() +
    facet_wrap(~ years_deciles, scales = "free_x") +
    geom_smooth(method = "lm")

## wrap grid victims not a victim
gg_ext_years$victim <- ifelse(gg_ext_years$extortions > 0, "yes", "no")

gg_ext_years$pop <- "All businesses"

subset(gg_ext_years, victim == "yes") -> gg_ext_years_tmp

gg_ext_years_tmp$pop <- "Victims"

rbind(gg_ext_years, gg_ext_years_tmp) -> gg_ext_years

select(gg_ext_years, - victim) -> gg_ext_years

years_scatterplots <- ggplot(gg_ext_years,
                             aes(x = years, y = extortions))

years_scatterplots +
    geom_point() +
    theme_bw() +
    facet_grid(pop ~ yearsquant, scales = "free_x") +
    geom_smooth(method = "lm")

years_scatterplots +
    geom_point() +
    theme_bw() +
    facet_grid(pop ~ years_deciles, scales = "free_x") +
    geom_smooth(method = "lm")


years_scatterplots +
    geom_point() +
    theme_bw() +
    facet_grid(pop ~ . , scales = "free_x") +
    geom_smooth(method = "lm", aes(colour = yearsquant), se = FALSE)

years_scatterplots <- ggplot(subset(gg_ext_years, yearsquant != "All years"),
                             aes(x = years, y = extortions))

years_scatterplots +
    geom_point() +
    theme_bw() +
    facet_grid(pop ~ . , scales = "free_x") +
    geom_smooth(method = "lm", aes(colour = yearsquant), se = FALSE)


```

# State level

Provide a brief summary of state-level figures. Include:

- n business (n())
- n victims (extortion and bribery) (filter by, then n())
- n repeat victims (filter by)
- n incidents (sum(extortions))
- n repeat incidents (n incidents - n victims)
- Gini index per state (for all and for business) (lets see...)
- plot of lorenz curve per state (let see...)


```{r state-level-summary, fig.width = 15, fig.height = 15}

enve_final %>%
    group_by(CVE_ENT, NOM_ENT) %>%
    summarise(n = n(),
              incidents = sum(extortions)) -> state_incidents_df

enve_final %>%
    filter(extortion_victim == "yes") %>%
    group_by(NOM_ENT) %>%
    summarise(victims = n()) -> state_evics_df

enve_final %>%
    filter(bribe_victim == "yes") %>%
    group_by(NOM_ENT) %>%
    summarise(bribe_vics = n()) -> state_bvics_df

enve_final %>%
    filter(rep_extortion_victim == 1) %>%
    group_by(NOM_ENT) %>%
    summarise(rep_ext_vics = n()) -> state_rep_vics_df

state_incidents_df %>%
    full_join(state_evics_df) %>%
    full_join(state_rep_vics_df) %>%
    mutate(rep_inci = incidents - rep_ext_vics) %>%
    full_join(state_bvics_df) -> state_summary

state_gini <- by(enve_final$extortions, enve_final$NOM_ENT, ineq::Gini)


state_gini_df <- data.frame(Gini = state_gini[1:32])

state_gini_victims <- by(enve_final$extortions[enve_final$extortions > 0],
                         enve_final$NOM_ENT[enve_final$extortions > 0],
                         ineq::Gini)

state_gini_df$Gini_vic <- data.frame(state_gini_victims[1:32])[,1]

state_gini_df$NOM_ENT <- as.factor(rownames(state_gini_df))

state_gini_tests <- by(enve_final$extortions, enve_final$NOM_ENT, mc_gini_test)

state_mc_gini_l <- lapply(state_gini_tests[1:32], function(x) x$mc_mean)

state_mc_gini_df <- data.frame(P.Gini= unlist(state_mc_gini_l))

rownames(state_mc_gini_df) <- names(state_mc_gini_l)

state_mc_gini_df$NOM_ENT <- as.factor(names(state_mc_gini_l))

state_mc_gini_hyp <- sapply(state_gini_tests[1:32],
                            function(x) if(x$mc_test == TRUE) "***"
                                        else "")

unlist(state_mc_gini_hyp) -> state_mc_gini_df$test

#### now mc gini test for victims

state_gini_vic_tests <- by(enve_final$extortions[enve_final$extortions > 0],
                         enve_final$NOM_ENT[enve_final$extortions > 0],
                         mc_gini_test)

state_mc_gini_vic_l <- lapply(state_gini_vic_tests[1:32], function(x) x$mc_mean)

state_mc_gini_df$P.Gini.vic <- data.frame(unlist(state_mc_gini_vic_l))[,1]

state_mc_gini_vic_hyp <- sapply(state_gini_vic_tests[1:32],
                            function(x) if(x$mc_test == TRUE) "***"
                                        else "")

unlist(state_mc_gini_vic_hyp) -> state_mc_gini_df$vic.test

state_summary %>%
    left_join(state_gini_df) %>%
    left_join(state_mc_gini_df) -> state_summary

state_summary$Gini <- as.numeric(unname(state_summary$Gini))
state_summary$Gini_vic <- as.numeric(unname(state_summary$Gini_vic))

kable(state_summary, format = "pandoc", digits = 3)

state_table <- by(enve_final$extortions, enve_final$NOM_ENT, victim_table)

lapply(seq_along(state_table), function(x)
    {
    cap <- names(state_table)[x]
    final <- kable(state_table[[x]], format = "pandoc", digits = 3,
                   caption = cap)
    return(final)
    }) -> state_dist_list

print_kables(state_dist_list)

victim_lorenz("extortions", data = enve_final, family = "poisson",
              reps = 500, by_var = "NOM_ABR")



```

Compare the bribe variable from the `area_level` data set with the one from this state summary above

```{r state-bribes}

bribe_mean <- mean(state_summary$bribe_vics)

state_summary %>%
    left_join(area_level) %>%
    dplyr::select(bribe_vics, log_bribe_vic) %>%
    mutate(log_bribe_vic2 = log(bribe_vics) - log(bribe_mean),
           dif = log_bribe_vic2 - log_bribe_vic) -> bribe_test

bribe_test$test <- round(bribe_test$dif, 2) == 0

kable(bribe_test, format = "pandoc")

```

# Models

There are two important changes to this modelling exercise. First, I am testing the influence of new state level variables that had not been previosly considered, as well as see if using years_deciles provides a better variable that yearsquant. Second, I will model extortion via two part models, using zero-inflated negative binomial and hurdle models. As the multilevel ZINB can only calculate a fixed zero-inflation factor (i.e. it is not poissbile to specify a separate equation for the zero-inflation part), I will focus on the hurdle models instead, testing hypotheses using these models.

## Model data frame

To avoid any problems with NA values that may lead to non-convergence, work with a data set onf only the relevant variables.

```{r model-data-frame}

enve_final %>%
    dplyr::select(extortions,
           bribes,
           yearsquant,
           years_deciles,
           subsector,
           size,
           log_deaths,
           log_bribe_vic,
           log_drug_crim,
           log_wpn_crim,
           law_index,
           comp_index,
           log_pop,
           log_nbus,
           state = NOM_ABR) -> enve_model

#### JUST FOR THIS TESTING EXERCISE, ADD MORE VICTIMS TO THE OTHER AND MEDIA CATEGORY

##### Comment out before sending #####

enve_model$extortions[which(enve_model$subsector == "Other")] <- rpois(10,1)


enve_model$extortions[which(enve_model$subsector == "Media")] <- rpois(45, 0.5)

##### Comment out before sending #####

##### Return to normal


enve_model$extortion_victim <- ifelse(enve_model$extortions == 0, 0, 1)

summary(enve_model)

summary(factor(enve_model$extortion_victim))
summary(factor(enve_final$extortion_victim))

length(enve_model[is.na(enve_model)])


```


## Negative binomial

I will not test every single model as before, as we have done this before. Thus I will start with the "best model" from previous exercises, changing the state homicide rate for the log deaths and log pop variables instead. To minimise any syntax mistakes, I will work with formula objects and update them as I proceed.


```{r model-failsafe-functions}

model_failsafe <- function(formula, data, family, multilevel = TRUE, ...)
{
    model <- tryCatch(glmmADMB::glmmadmb(formula = formula,
                                data = data,
                                family = family,
                                zeroInflation = FALSE, 
                                ...,
                                admb.opts = glmmADMB::admbControl(noinit = FALSE, shess=FALSE),
                                extra.args = "-ndi 60000"), 
                      error = function(e)
                          {
                          print("glmmADMB failed")
                          print(e)
                          e
                          })
    
    #tc <- tryCatch(summary(model), error = function(e) e)
    
    if(is(model, "error"))
    {
        print("glmmADMB failed, trying fit with other packages")
        if(isTRUE(multilevel))
        {
            if(family != "nbinom")
            {
                model <- tryCatch(lme4::glmer(formula = formula,
                                     data = data,
                                     family = family),
                                  error = function(e) e)
            }
            if(family == "nbinom")
            {
                model <- tryCatch(lme4::glmer.nb(formula = formula,
                                     data = data),
                                  error = function(e) e)
            }
        }
        else
        {
          if(family != "nbinom")
            {
                model <- tryCatch(glm(formula = formula,
                                     data = data,
                                     family = family),
                                  error = function(e) e)
            }
            if(family == "nbinom")
            {
                model <- tryCatch(MASS::glm.nb(formula = formula,
                                     data = data),
                                  error = function(e) e)
            }  
        }
        
        if(is(model, "error"))
        {
            print(model)
            print("Second attempt also failed")
        }
    }
    else {print("The model was fitted correctly with glmmadmb")}
    
    return(model)
}

```


```{r main-formula}

count_formula <- as.formula("extortions ~
                            bribes +
                            yearsquant +
                            subsector +
                            size +
                            (1 | state)")

```


```{r multilevel-negative-binomial}

admbControl <- glmmADMB::admbControl

mnb1 <- model_failsafe(formula = count_formula, 
                       data = enve_model, 
                       family = "nbinom")

summary(mnb1)
confint(mnb1)

get_glmmadmb(mnb1)

# vs Poisson

mp1 <- model_failsafe(count_formula, 
                      data = enve_model, 
                      family = "poisson")


summary(mp1)
confint(mp1)

get_glmmadmb(mp1)

screenreg(list(mnb1, mp1), single.row = TRUE,
          custom.model.names = c("negbin", "poisson"))

lrtest(mp1, mnb1)

# vs single level nb

nb1_formula <- update(count_formula, . ~ . - (1 | state))

nb1 <- model_failsafe(nb1_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = FALSE)

summary(nb1)
confint(nb1)

get_glmmadmb(nb1)

screenreg(list(mnb1, nb1), single.row = TRUE,
          custom.model.names = c("multilevel nb", "single level nb"))

lrtest(nb1, mnb1)

vif(mnb1)

lm1 <- lm(update(count_formula, . ~ . - (1 | state)), data = enve_model)

summary(lm1)

vif(lm1)

mnb1_drop <- drop1(mnb1, test = "Chisq")

mnb1_drop

# NB null, multi and one level

nb_null_formula <- update(count_formula, . ~ 1)

nb_null <- model_failsafe(nb_null_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = FALSE)

summary(nb_null)
get_glmmadmb(nb_null)

lrtest(nb_null, nb1)

lrtest(nb_null, mnb1)

mnb_null_formula <- update(count_formula, . ~ (1 | state))

mnb_null <- model_failsafe(mnb_null_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb_null)
get_glmmadmb(mnb_null)

lrtest(nb_null, mnb_null)

lrtest(mnb_null, mnb1)


```

```{r negative-binomial-years_deciles}

mnb2_formula <- update(count_formula, . ~ . - yearsquant + years_deciles)

mnb2 <- model_failsafe(mnb2_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb2)
confint(mnb2)

get_glmmadmb(mnb2)

screenreg(list(mnb1, mnb2), single.row = TRUE,
          custom.model.names = c("year qunitiles", "year deciles"))

```

Now start introducing the state-level variables. First, log deaths, then the saturated model, then test them. Also run excluding all business-level and compare.

```{r mnb-log_deaths}

mnb3_formula <- update(count_formula, . ~ . + log_deaths + log_pop)

mnb3 <-  model_failsafe(mnb3_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb3)
confint(mnb3)
get_glmmadmb(mnb3)

lrtest(mnb1, mnb3)

vif(mnb3)

lm2 <- update(lm1, . ~ . + log_deaths + log_pop)

vif(lm2)

# drop pop

mnb4_formula <- update(count_formula, . ~ . + log_deaths)

mnb4 <- model_failsafe(mnb4_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb4)
confint(mnb4)
get_glmmadmb(mnb4)

lrtest(mnb1, mnb4, mnb3)

vif(mnb4)

lm3 <- update(lm2, . ~ . - log_pop)

vif(lm3)

# drop deaths

mnb5_formula <- update(count_formula, . ~ . + log_pop)

mnb5 <- model_failsafe(mnb5_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb5)
confint(mnb5)
get_glmmadmb(mnb5)

lrtest(mnb1, mnb5, mnb3)

vif(mnb5)

lm4 <- update(lm2, . ~ . - log_deaths)

vif(lm4)

####
screenreg(list(negbin = mnb1,
               "deaths + pop" = mnb3,
               "deaths" = mnb4,
               "pop" = mnb5),
          single.row = TRUE)

```

```{r mnb-state-bribes}

mnb6_formula <- update(count_formula, . ~ . + log_bribe_vic + log_nbus)

mnb6 <- model_failsafe(mnb6_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb6)
confint(mnb6)
get_glmmadmb(mnb6)

vif(mnb6)

lm5 <- update(lm1, . ~ . + log_bribe_vic + log_nbus)
vif(lm5)

# drop nbus

mnb7_formula <- update(count_formula, . ~ . + log_bribe_vic)

mnb7 <- model_failsafe(mnb7_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb7)
confint(mnb7)
get_glmmadmb(mnb7)

vif(mnb7)

lm6 <- update(lm5, . ~ . - log_nbus)
vif(lm5)

lrtest(mnb1, mnb7, mnb6)

# test vs business-level bribes

mnb8_formula <- update(count_formula, . ~ . + log_bribe_vic + log_nbus - bribes)

mnb8 <- model_failsafe(mnb8_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb8)
confint(mnb8)
get_glmmadmb(mnb8)

vif(mnb8)

lrtest(mnb8, mnb6)

mnb9_formula <- update(mnb7_formula, . ~ . - bribes)

mnb9 <- model_failsafe(mnb9_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb9)
confint(mnb9)
get_glmmadmb(mnb9)

vif(mnb9)

mnb10_formula <- update(count_formula, . ~ . - bribes)

mnb10 <- model_failsafe(mnb10_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb10)
confint(mnb10)
get_glmmadmb(mnb10)

vif(mnb10)

lrtest(mnb10, mnb1, mnb7, mnb6)

screenreg(list("no bribes" = mnb10,
               "bus bribes" = mnb1,
               "b + s bribes" = mnb7,
               "bs_bribes + nbus" = mnb6),
          single.row = TRUE)

lrtest(mnb10, mnb9, mnb8, mnb6)


screenreg(list("no bribes" = mnb10,
               "state bribes" = mnb9,
               "s bribes + nbus" = mnb8,
               "bs_bribes + nbus" = mnb6),
          single.row = TRUE)

## Include with log_deaths and pop

mnb11_formula <- update(mnb3_formula, . ~ . + log_bribe_vic + log_nbus)

mnb11 <- model_failsafe(mnb11_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb11)
confint(mnb11)
get_glmmadmb(mnb11)

vif(mnb11)

lm7 <- update(lm2, . ~ . + log_bribe_vic + log_nbus)
vif(lm7)

mnb12_formula <- update(mnb11_formula,  . ~ . - log_nbus)

mnb12 <- model_failsafe(mnb12_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb12)
confint(mnb12)
get_glmmadmb(mnb12)

vif(mnb12)

lm8 <- update(lm7, . ~ . - log_nbus)
vif(lm8)

lrtest(mnb3, mnb12, mnb11)

screenreg(list("deaths + pop" = mnb3,
               "+ s bribes" = mnb12,
               "+ nbus" = mnb11),
          single.row = TRUE)


```

```{r mnb-state-level-fed-wpn-crimes}

# firearms-related federal crimes

mnb13_formula <- update(count_formula, . ~ . + log_wpn_crim)

mnb13 <- model_failsafe(mnb13_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb13)
confint(mnb13)
get_glmmadmb(mnb13)

vif(mnb13)

lrtest(mnb1, mnb13)

mnb14_formula <- update(mnb4_formula, . ~ . + log_wpn_crim)

mnb14 <- model_failsafe(mnb14_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb14)
confint(mnb14)
get_glmmadmb(mnb14)

vif(mnb14)


lm9 <- update(lm3, . ~ . + log_wpn_crim)
vif(lm9)



mnb15_formula <- update(mnb3_formula, . ~ . + log_wpn_crim)

mnb15 <- model_failsafe(mnb15_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)


summary(mnb15)
confint(mnb15)
get_glmmadmb(mnb15)

vif(mnb15)


lm10 <- update(lm2, . ~ . + log_wpn_crim)
vif(lm10)


lrtest(mnb4, mnb14, mnb15)

lrtest(mnb3, mnb15)


# droping deaths

mnb16_formula <- update(mnb15_formula, . ~ . - log_deaths)

mnb16 <- model_failsafe(mnb16_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb16)
confint(mnb16)
get_glmmadmb(mnb16)

vif(mnb16)

lm11 <- update(lm10, . ~ . - log_deaths)
vif(lm11)


lrtest(mnb5 ,mnb16, mnb15)

lrtest(mnb13, mnb16)

screenreg(list("No state" = mnb1,
               "deaths" = mnb4,
               "deaths +  pop" = mnb3,
               "wpns" = mnb13,
               "wpns + dth" = mnb14,
               "wpns + pop" = mnb16,
               "wpns + dth + pop" = mnb15),
          single.row = FALSE)

## include state bribes var

mnb17_formula <- update(mnb16_formula, . ~ . + log_bribe_vic)

mnb17 <- model_failsafe(mnb17_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb17)
confint(mnb17)
get_glmmadmb(mnb17)

vif(mnb17)

mnb18_formula <- update(mnb17_formula, . ~ . + log_nbus)

mnb18 <- model_failsafe(mnb18_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb18)
confint(mnb18)
get_glmmadmb(mnb18)

vif(mnb18)

lm12 <- update(lm10, . ~ . + log_bribe_vic)

vif(lm12)


lm13 <- update(lm12, . ~ . + log_nbus)

vif(lm13)


lm14 <- update(lm13, . ~ . - log_deaths)

vif(lm14)


lrtest(mnb16, mnb17, mnb18)

mnb19_formula <- update(mnb17_formula, . ~ . - log_pop)

mnb19 <- model_failsafe(mnb19_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb19)
confint(mnb19)
get_glmmadmb(mnb19)

lrtest(mnb19, mnb16)

screenreg(list("no state" = mnb1,
               "wpns + pop" = mnb16,
               "+ s bribes" = mnb17,
               "+ nbus" = mnb18,
               "wpns + s bribes" = mnb19),
          single.row = TRUE)


```

```{r mnb-state-level-fed-drug-crimes}

# drugs-related federal crimes

mnb20_formula <- update(mnb18_formula, . ~ . + log_drug_crim)

mnb20 <- model_failsafe(mnb20_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb20)
confint(mnb20)
get_glmmadmb(mnb20)
vif(mnb20)

lm15 <- update(lm14, . ~ . + log_drug_crim)
vif(lm15)


lrtest(mnb18, mnb20)

# drop log_wpn_crim

mnb21_formula <- update(mnb20_formula, . ~ . - log_wpn_crim)

mnb21 <- model_failsafe(mnb21_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb21)
confint(mnb21)
get_glmmadmb(mnb21)

vif(mnb21)


lm16 <- update(lm15, . ~ . - log_wpn_crim)
vif(lm16)


lrtest(mnb21, mnb20)

# drop log_drug_crim

mnb22_formula <- update(mnb21_formula, . ~ . -  log_pop)

mnb22 <- model_failsafe(mnb22_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb22)
confint(mnb22)
get_glmmadmb(mnb22)

mnb23_formula <- update(mnb22_formula, . ~ . - log_drug_crim)

mnb23 <- model_failsafe(mnb23_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb23)
confint(mnb23)
get_glmmadmb(mnb23)

lrtest(mnb23, mnb22, mnb21)

# include deaths

mnb24_formula <- update(mnb20_formula, . ~ . + log_deaths)

mnb24 <- model_failsafe(mnb24_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb24)
confint(mnb24)
get_glmmadmb(mnb24)

vif(mnb24)


lm17 <- update(lm15, . ~ . + log_deaths)
vif(lm17)


# no fed crimes

mnb25_formula <- update(mnb18_formula, . ~ . - log_wpn_crim)

mnb25 <- model_failsafe(mnb25_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb25)
confint(mnb25)
get_glmmadmb(mnb25)

vif(mnb25)

mnb26_formula <- update(mnb20_formula, . ~ . -  log_pop)

mnb26 <- model_failsafe(mnb26_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb26)
confint(mnb26)
get_glmmadmb(mnb26)

lrtest(mnb25, mnb20)


screenreg(list("no fed" = mnb25,
               "- drug + wpn" = mnb18,
               "+ drug - wpn" = mnb21,
               "+ drug + wpn - pop " = mnb26,
               "+ drug + wpn + pop" = mnb20),
          single.row = TRUE)


```


Controls: Competitive index

- Include both, drop 1, test
- both + homicides, test


```{r mnb-index-controls}

## controls: competitive index

mnb27_formula <- update(mnb20_formula, . ~ . + comp_index)

mnb27 <- model_failsafe(mnb27_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb27)
confint(mnb27)
get_glmmadmb(mnb27)

lrtest(mnb20, mnb27)

vif(mnb27)


lm18 <- update(lm15, . ~ . + comp_index)
vif(lm18)


# control: rule of law index

mnb28_formula <- update(mnb27_formula, . ~ . + law_index)

mnb28 <- model_failsafe(mnb28_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb28)
confint(mnb28)
get_glmmadmb(mnb28)

lrtest(mnb27, mnb28)

lrtest(mnb20, mnb28)

vif(mnb28)


lm19 <- update(lm18, . ~ . + law_index)
vif(lm19)


## dropping comp_index and keeping law index

mnb29_formula <- update(mnb28_formula, . ~ . - comp_index)

mnb29 <- model_failsafe(mnb29_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb29)
confint(mnb29)
get_glmmadmb(mnb29)

lrtest(mnb20, mnb29)

vif(mnb29)


lm20 <- update(lm19, . ~ . - comp_index)
vif(lm20)


## Including deaths

mnb30_formula <- update(mnb28_formula, . ~ . + log_deaths)

mnb30 <- model_failsafe(mnb30_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb30)
confint(mnb30)
get_glmmadmb(mnb30)

lrtest(mnb28, mnb30)

vif(mnb30)


lm21 <- update(lm19, . ~ . + log_deaths)
vif(lm21)


screenreg(list("no index" = mnb20,
               "comp" = mnb27,
               "law" = mnb29,
               "comp + law" = mnb28,
               "comp + law + deaths" = mnb30),
          single.row = TRUE)

```

Final spec:
- business_level + sbribes, wpn, drug, nbus, pop, index1, index2
    - vif
- test: remove controls
- test: remove business_level vars (multi and single level)
- test: full, single and multilevel spec
- test: include deaths
- MNB vs MP

```{r mnb-final-spec}

mnb_final <- mnb28

mnb_final_formula <- mnb28_formula

summary(mnb_final)
confint(mnb_final)
get_glmmadmb(mnb_final)

vif(mnb_final)


# Test all state level vars
lrtest(mnb1, mnb_final)

# Test vs multilevel null

summary(mnb_null)
get_glmmadmb(mnb_null)

lrtest(mnb_null, mnb_final)

# test vs sigle-level full and null

nb_final_formula <- update(mnb_final_formula, . ~ . - (1 | state))

nb_final <- model_failsafe(nb_final_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(nb_final)
confint(nb_final)
get_glmmadmb(nb_final)

lrtest(nb_final, mnb_final)

summary(nb_null)
get_glmmadmb(nb_null)

lrtest(nb_null, mnb_null)

lrtest(nb_null, mnb_final)

lrtest(nb_null, nb_final)

# Only state vars

mnb_only_state_formula <- update(mnb_null_formula, . ~ . + log_pop + log_wpn_crim + log_drug_crim +
                             log_bribe_vic + log_nbus + comp_index + law_index)

mnb_only_state <- model_failsafe(mnb_only_state_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)


summary(mnb_only_state)
confint(mnb_only_state)
get_glmmadmb(mnb_only_state)

nb_only_state_formula <- update(mnb_only_state_formula, . ~ . - (1 | state))

nb_only_state <- model_failsafe(nb_only_state_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = FALSE)

summary(nb_only_state)
confint(nb_only_state)
get_glmmadmb(nb_only_state)

lrtest(nb_only_state, mnb_only_state)

vif(nb_only_state)

lm_only_state <- update(lm1, nb_only_state_formula)

vif(lm_only_state)

## No controls

mnb_noc_formula <- update(mnb_final_formula, . ~ . - log_pop - log_nbus - comp_index -
                      law_index)

mnb_noc <- model_failsafe(mnb_noc_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)

summary(mnb_noc)
confint(mnb_noc)
get_glmmadmb(mnb_noc)

vif(mnb_noc)


lm_noc <- update(lm1, update(mnb_noc_formula, . ~ . - (1 | state)))

vif(lm_noc)

screenreg(list("MNB" = mnb_final,
               "No state vars" = mnb1,
               "Only state vars" = mnb_only_state,
               "No controls" = mnb_noc,
               "Null" = mnb_null,
               "NB null" = nb_null))

## Including deaths

mnb_f_deaths_formula <- update(mnb_final_formula, . ~ . + log_deaths)

mnb_f_deaths <- model_failsafe(mnb_f_deaths_formula,
                      data = enve_model,
                      family = "nbinom", multilevel = TRUE)


summary(mnb_f_deaths)
confint(mnb_f_deaths)
get_glmmadmb(mnb_f_deaths)

lrtest(mnb_final, mnb_f_deaths)

vif(mnb_f_deaths)

lm_f_deaths <- lm(update(nb_final_formula, . ~ . +  log_deaths),
                  data = enve_model)
vif(lm_f_deaths)

screenreg(list("MNB" = mnb_final,
          "With deaths" = mnb_f_deaths),
          single.row = TRUE)

## Vs Poisson


mp_final <- model_failsafe(mnb_final_formula,
                      data = enve_model,
                      family = "poisson", multilevel = TRUE)

summary(mp_final)
confint(mp_final)
get_glmmadmb(mp_final)

lrtest(mp_final, mnb_final)

screenreg(list("MNB" = mnb_final, "M Poisson" = mp_final), single.row = TRUE)


```

## Zero-inflated models

Multilevel zero inflated using glmmadmb
- fully specified: MZINB vs MNB vs MZIP
- null: MZINB vs MNB
- Full and null: MZINB vs ZINB
- No state: MZINB vs MNB
- No bus: MZINB vs MNB

```{r mzinb-glmmadmb}

mzinb_full <- glmmadmb(mnb_final_formula, data = enve_model,
                       family = "nbinom", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")

summary(mzinb_full)
confint(mzinb_full)
get_glmmadmb(mzinb_full)

lrtest(mnb_final, mzinb_full)

mzip_full <- glmmadmb(mnb_final_formula, data = enve_model,
                       family = "poisson", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")

summary(mzip_full)
confint(mzip_full)
get_glmmadmb(mzip_full)

lrtest(mzip_full, mzinb_full)

zinb_full_formula <- update(mnb_final_formula, . ~ . - (1 | state))

zinb_full <- glmmadmb(zinb_full_formula, data = enve_model,
                       family = "nbinom", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")

summary(zinb_full)
confint(zinb_full)
get_glmmadmb(zinb_full)

lrtest(zinb_full, mzinb_full)


screenreg(list("MNB" = mnb_final,
               "MZINB" = mzinb_full,
               "MZIP" = mzip_full,
               "ZINB" = zinb_full),
          single.row = TRUE)

# Dropping state vars

mzinb_no_state <- glmmadmb(count_formula, data = enve_model,
                       family = "nbinom", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")

summary(mzinb_no_state)
confint(mzinb_no_state)
get_glmmadmb(mzinb_no_state)

lrtest(mzinb_no_state, mzinb_full)

# Dropping bus vars

mzinb_only_state <- glmmadmb(mnb_only_state_formula, data = enve_model,
                       family = "nbinom", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")

summary(mzinb_only_state)
confint(mzinb_only_state)
get_glmmadmb(mzinb_only_state)

lrtest(mzinb_only_state, mzinb_full)

screenreg(list("MZINB Full" = mzinb_full,
               "No state" = mzinb_no_state,
               "No bus" = mzinb_only_state),
          single.row = TRUE)

# include deaths

mzinb_deaths <- glmmadmb(update(mnb_final_formula, . ~ . + log_deaths), 
                         data = enve_model,
                       family = "nbinom", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")

summary(mzinb_deaths)
confint(mzinb_deaths)
get_glmmadmb(mzinb_deaths)

lrtest(mzinb_full, mzinb_deaths)

## Null models: MZINB vs MNB

mzinb_null <- glmmadmb(update(mnb_final_formula, . ~ 1 + (1 | state)), 
                         data = enve_model,
                       family = "nbinom", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")

summary(mzinb_null)
get_glmmadmb(mzinb_null)

lrtest(mzinb_null, mnb_null)

## Null models: MZINB vs ZINB

zinb_null <- glmmadmb(update(mnb_final_formula, . ~ 1), 
                         data = enve_model,
                       family = "nbinom", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")

summary(zinb_null)
get_glmmadmb(zinb_null)

lrtest(zinb_null, mzinb_null)


screenreg(list("MNB Null" = mnb_null,
               "MZINB Null" = mzinb_null,
               "ZINB Null" = zinb_null),
          single.row = TRUE)
```

Single level ZINB using glmmadmb
- fully specified: ZINB vs NB vs ZIP
- null: ZINB vs NB
- No state: ZINB vs NB
- No bus: ZINB vs NB

```{r zinb-glmmadmb}

lrtest(nb_final, zinb_full)

zip_full <- glmmadmb(update(mnb_final_formula, . ~ . - (1 | state)), 
                         data = enve_model,
                       family = "poisson", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")
    
summary(zip_full)
confint(zip_full)
get_glmmadmb(zip_full)

lrtest(zip_full, zinb_full)

lrtest(nb_null, zinb_null)

# no state

zinb_no_state <- glmmadmb(nb1_formula, data = enve_model,
                          family = "nbinom", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")

summary(zinb_no_state)
confint(zinb_no_state)
get_glmmadmb(zinb_no_state)

lrtest(nb1, zinb_no_state)

# no business level measurements

zinb_only_state <- glmmadmb(nb_only_state_formula, data = enve_model,
                          family = "nbinom", zeroInflation = TRUE,
                       admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                       extra.args = "-ndi 60000")

summary(zinb_only_state)
confint(zinb_only_state)
get_glmmadmb(zinb_only_state)

lrtest(nb_only_state, zinb_only_state)

```


Single level ZINB using pscl
- Different equation for zero inflation
- count: business level, zero: state level
- count: state level, zero: business level


```{r zinb-pscl}

zi_formula <- as.formula(extortions ~
                             bribes +
                             yearsquant +
                             subsector +
                             size +
                             log_pop +
                             log_wpn_crim +
                             log_bribe_vic +
                             log_nbus +
                             log_drug_crim +
                             comp_index +
                             law_index | 1)

zinb_pscl_simple_full <- zeroinfl(zi_formula, data = enve_model,
                                  dist = "negbin")
summary(zinb_pscl_simple_full)
confint(zinb_pscl_simple_full)

lrtest(nb_final, zinb_pscl_simple_full)

nb_mass_final <- glm.nb(nb_final_formula, data = enve_model)

summary(nb_mass_final)
confint(nb_mass_final)

lrtest(nb_mass_final, zinb_pscl_simple_full)
vuong(nb_mass_final, zinb_pscl_simple_full)

zi_formula <- as.formula(extortions ~
                             bribes +
                             yearsquant +
                             subsector +
                             size +
                             log_pop +
                             log_wpn_crim +
                             log_bribe_vic +
                             log_nbus +
                             log_drug_crim +
                             comp_index +
                             law_index |
                             bribes +
                             yearsquant +
                             subsector +
                             size +
                             log_pop +
                             log_wpn_crim +
                             log_bribe_vic +
                             log_nbus +
                             log_drug_crim +
                             comp_index +
                             law_index)

zinb_pscl_full <- zeroinfl(zi_formula, data = enve_model,
                                  dist = "negbin")
summary(zinb_pscl_full)
confint(zinb_pscl_full)

lrtest(nb_final, zinb_pscl_full)

lrtest(zinb_pscl_simple_full ,zinb_pscl_full)

lrtest(nb_mass_final, zinb_pscl_full)
vuong(nb_mass_final, zinb_pscl_full)

## Constant on either side of equation

zinb_pscl_nullc <- update(zinb_pscl_full, . ~ 1 | . )

summary(zinb_pscl_nullc)
confint(zinb_pscl_nullc)


lrtest(zinb_pscl_nullc, zinb_pscl_full)
vuong(zinb_pscl_nullc, zinb_pscl_full)

zinb_pscl_c_all_z_state <- update(zinb_pscl_full, . ~ . | . - bribes -
                             yearsquant -
                             subsector -
                             size )

summary(zinb_pscl_c_all_z_state)
confint(zinb_pscl_c_all_z_state)

lrtest(zinb_pscl_simple_full, zinb_pscl_c_all_z_state)
vuong(zinb_pscl_simple_full, zinb_pscl_c_all_z_state)

zinb_pscl_c_state_l_z_all <- update(zinb_pscl_full, . ~ . - bribes -
                             yearsquant -
                             subsector -
                             size | . )

summary(zinb_pscl_c_state_l_z_all)
confint(zinb_pscl_c_state_l_z_all)

lrtest(zinb_pscl_simple_full, zinb_pscl_c_state_l_z_all)
vuong(zinb_pscl_simple_full, zinb_pscl_c_state_l_z_all)


screenreg(list("ZINB Full" = zinb_pscl_full,
               "Count: Null" = zinb_pscl_nullc,
               "Zero: Null" = zinb_pscl_simple_full,
               "Zero: state" = zinb_pscl_c_all_z_state,
               "Count: state" = zinb_pscl_c_state_l_z_all),
          single.row = TRUE)


```



## Hurdle models

First prepare data sets

```{r hurdle-data}

enve_trunc <- subset(enve_model, extortions > 0)

```

Multilevel Hurdle model using glmmadmb
- fully specified: MHNB vs MNB
- Full: MHNB vs HNB

Compare:
- Binary: state; Count: all vs. Full
- Binary: bus; Count: all vs. Full
- Binary: all; Count: bus vs. Full
- Binary: all; Count: state vs. Full


```{r hurdle-models}

binary_formula <- update(mnb_final_formula, extortion_victim ~ .)

# Full, equal variable, hurdle models

## Binary part first

mlogit_full <- model_failsafe(binary_formula, data = enve_model,
                        family = "binomial", multilevel = TRUE)

summary(mlogit_full)
confint(mlogit_full)
get_glmmadmb(mlogit_full)

## Count part

mtnb_full <- glmmadmb(mnb_final_formula, data = enve_trunc,
                      family = "truncnbinom",
                      admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                      extra.args = "-ndi 60000")

summary(mtnb_full)
confint(mtnb_full)
get_glmmadmb(mtnb_full)


### Compare joint IC with Full MNB and ZINB

compare_hurdle2other(mlogit_full, mtnb_full, mnb_final, mzinb_full)


screenreg(list("MNB" = mnb_final,
               "MZINB" = mzinb_full,
               "Logit" = mlogit_full,
               "Trunc. NB" = mtnb_full),
          single.row = TRUE)

# Full, single level, equal equation hurdle

## Binary part first

logit_full_formula <- update(binary_formula, . ~ . - (1 | state))

logit_full <- model_failsafe(logit_full_formula, data = enve_model,
                        family = "binomial", multilevel = FALSE)

summary(logit_full)
confint(logit_full)
get_glmmadmb(logit_full)

## Count part

tnb_full <- glmmadmb(update(mnb_final_formula, . ~ . - (1 | state)), 
                     data = enve_trunc,
                      family = "truncnbinom",
                      admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                      extra.args = "-ndi 60000")

summary(tnb_full)
confint(tnb_full)
get_glmmadmb(tnb_full)


### Compare joint IC with Full NB and ZINB

compare_hurdle2other(logit_full, tnb_full, nb_final, zinb_full)


screenreg(list("NB" = nb_final,
               "ZINB" = zinb_full,
               "Logit" = logit_full,
               "Trunc. NB" = tnb_full),
          single.row = TRUE)

## Compare two hurdle modles: multilevel vs single level

hurdle_compare(joint_ic(logit_full, tnb_full),
               joint_ic(mlogit_full, mtnb_full),
               modnames = c("Single level", "Multilevel"))

# - Binary: state; Count: all vs. Full

mlogit_state_formula <- update(mnb_only_state_formula, extortion_victim ~ .)

mlogit_state <- model_failsafe(mlogit_state_formula, data = enve_model,
                         family = "binomial", multilevel = TRUE)
summary(mlogit_state)
confint(mlogit_state)
get_glmmadmb(mlogit_state)

lrtest(mlogit_state, mlogit_full)

# - Binary: bus; Count: all vs. Full

mlogit_bus <- model_failsafe(update(count_formula, extortion_victim ~ .), 
                             data = enve_model,
                         family = "binomial", multilevel = TRUE)
summary(mlogit_bus)
confint(mlogit_bus)
get_glmmadmb(mlogit_bus)

lrtest(mlogit_bus, mlogit_full)

# - Binary: all; Count: bus vs. Full

mtnb_bus <- glmmadmb(count_formula, data = enve_trunc,
                      family = "truncnbinom",
                      admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                      extra.args = "-ndi 60000")

summary(mtnb_bus)
confint(mtnb_bus)
get_glmmadmb(mtnb_bus)

lrtest(mtnb_bus, mtnb_full)


# - Binary: all; Count: state vs. Full

mtnb_state <- glmmadmb(mnb_only_state_formula, data = enve_trunc,
                      family = "truncnbinom",
                      admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                      extra.args = "-ndi 60000")

summary(mtnb_state)
confint(mtnb_state)
get_glmmadmb(mtnb_state)

lrtest(mtnb_state, mtnb_full)


# Binary with deaths

mlogit_deaths_formula <- update(binary_formula, . ~ . + log_deaths)

mlogit_deaths <- model_failsafe(binary_formula, data = enve_model,
                        family = "binomial", multilevel = TRUE)

summary(mlogit_deaths)
confint(mlogit_deaths)
get_glmmadmb(mlogit_deaths)

lrtest(mlogit_full, mlogit_deaths)

# count with deaths

mtnb_deaths_formula <- update(mnb_final_formula, . ~ . + log_deaths)

mtnb_deaths <- glmmadmb(mtnb_deaths_formula, data = enve_trunc,
                      family = "truncnbinom",
                      admb.opts = admbControl(noinit = FALSE, shess=FALSE),
                      extra.args = "-ndi 60000")

summary(mtnb_deaths)
confint(mtnb_deaths)
get_glmmadmb(mtnb_deaths)

lrtest(mtnb_full, mtnb_deaths)

# together with deaths

hurdle_compare(joint_ic(mlogit_full, mtnb_full),
               joint_ic(mlogit_deaths, mtnb_deaths),
               modnames = c("Full", "+ deaths"))

compare_hurdle2other(mlogit_deaths, mtnb_deaths, mnb_f_deaths)

```


```{r hurdle-pscl}

update.hurdle <- function(object, new, ...)
{
    call <- object$call
    call$formula <- update(Formula::as.Formula(formula(object)), new)
    eval.parent(call)
}

zi_formula <- as.formula(extortions ~
                             bribes +
                             yearsquant +
                             subsector +
                             size +
                             log_pop +
                             log_wpn_crim +
                             log_bribe_vic +
                             log_nbus +
                             log_drug_crim +
                             comp_index +
                             law_index | 1)

hurdle_pscl_simple_full <- hurdle(zi_formula, data = enve_model,
                                  dist = "negbin")
summary(hurdle_pscl_simple_full)
confint(hurdle_pscl_simple_full)

lrtest(nb_final, hurdle_pscl_simple_full)

lrtest(nb_mass_final, hurdle_pscl_simple_full)
vuong(nb_mass_final, hurdle_pscl_simple_full)

zi_formula <- as.formula(extortions ~
                             bribes +
                             yearsquant +
                             subsector +
                             size +
                             log_pop +
                             log_wpn_crim +
                             log_bribe_vic +
                             log_nbus +
                             log_drug_crim +
                             comp_index +
                             law_index |
                             bribes +
                             yearsquant +
                             subsector +
                             size +
                             log_pop +
                             log_wpn_crim +
                             log_bribe_vic +
                             log_nbus +
                             log_drug_crim +
                             comp_index +
                             law_index)

hurdle_pscl_full <- hurdle(zi_formula, data = enve_model,
                                  dist = "negbin")
summary(hurdle_pscl_full)
confint(hurdle_pscl_full)

lrtest(nb_final, hurdle_pscl_full)

lrtest(hurdle_pscl_simple_full, hurdle_pscl_full)

lrtest(nb_mass_final, hurdle_pscl_full)
vuong(nb_mass_final, hurdle_pscl_full)

## Constant on either side of equation

hurdle_pscl_nullc <- update(hurdle_pscl_full, . ~ 1 | . )

summary(hurdle_pscl_nullc)
confint(hurdle_pscl_nullc)

lrtest(hurdle_pscl_nullc, hurdle_pscl_full)
vuong(hurdle_pscl_nullc, hurdle_pscl_full)

hurdle_pscl_c_all_z_state <- update(hurdle_pscl_full, . ~ . | . - bribes -
                             yearsquant -
                             subsector -
                             size )

summary(hurdle_pscl_c_all_z_state)
confint(hurdle_pscl_c_all_z_state)

lrtest(hurdle_pscl_simple_full, hurdle_pscl_c_all_z_state)
vuong(hurdle_pscl_simple_full, hurdle_pscl_c_all_z_state)

hurdle_pscl_c_state_l_z_all <- update(hurdle_pscl_full, . ~ . - bribes -
                             yearsquant -
                             subsector -
                             size | . )

confint(hurdle_pscl_c_state_l_z_all)

lrtest(hurdle_pscl_simple_full, hurdle_pscl_c_state_l_z_all)
vuong(hurdle_pscl_simple_full, hurdle_pscl_c_state_l_z_all)


screenreg(list("Hurdle Full" = hurdle_pscl_full,
               "Count: Null" = hurdle_pscl_nullc,
               "Logit: Null" = hurdle_pscl_simple_full,
               "Logit: state" = hurdle_pscl_c_all_z_state,
               "Count: state" = hurdle_pscl_c_state_l_z_all),
          single.row = TRUE)




```

# The end

```{r endtime}
endtime <- proc.time()

endtime - starttime
```
